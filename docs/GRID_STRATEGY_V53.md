# 网格策略（v5.3）实现文档

## 概述

v5.3版本在震荡区间（RANGE_BOUND）引入了网格策略，用于在箱体内进行低买高卖（牛市）或高卖低买（熊市）的自动化交易。

## 核心逻辑

### 1. 触发条件

- **市场状态**：必须是 `RANGE_BOUND`（震荡区间）
- **箱体要求**：箱体区间 >= 5%（`GRID_MIN_BOX_RANGE_PCT`）
- **价格位置**：当前价格必须在箱体内
- **大趋势方向**：
  - 牛市（`BigTrend.BULLISH`）：只做多网格（低买高卖）
  - 熊市（`BigTrend.BEARISH`）：只做空网格（高卖低买）
  - 中性（`BigTrend.NEUTRAL`）：不交易

### 2. 网格参数计算

#### 网格间隔
- **最小间隔**：1%（`GRID_MIN_INTERVAL_PCT`）
- **动态计算**：`max(1%价格, 0.5倍ATR)`
- **目的**：确保网格间隔足够大，避免频繁交易

#### 网格层数
- **最大层数**：10层（`GRID_MAX_LAYERS`）
- **实际层数**：`min(箱体范围/网格间隔, 10)`
- **要求**：至少2层才启用网格

#### 仓位计算
- **每层风险**：账户的0.5%（`GRID_RISK_PER_LAYER`）
- **止损距离**：网格间隔的一半（保守）
- **仓位大小**：`每层风险 / 止损距离`
- **总风险限制**：不超过币种仓位上限（42%）

### 3. 做多网格（牛市）

- **起点**：箱体下沿（`box_low`）
- **方向**：从下往上
- **止盈**：上一层价格或箱体上沿（最后一层）
- **止损**：下一层下方（网格间隔的一半）

### 4. 做空网格（熊市）

- **起点**：箱体上沿（`box_high`）
- **方向**：从上往下
- **止盈**：下一层价格或箱体下沿（最后一层）
- **止损**：上一层上方（网格间隔的一半）

### 5. 交易执行

#### 开仓条件
- 价格接近网格层价格（容差1%）
- 该层没有持仓
- 价格仍在箱体内

#### 平仓条件
- **止盈**：价格达到网格层的止盈价
- **止损**：价格触发止损价
- **箱体突破**：价格离开箱体（由持仓管理处理）

## 配置参数

```python
# StrategyConfig 新增参数
ENABLE_GRID_TRADING: bool = True  # 启用网格策略
GRID_MIN_INTERVAL_PCT: float = 1.0  # 网格最小间隔（1%）
GRID_MIN_BOX_RANGE_PCT: float = 5.0  # 箱体最小区间（5%）
GRID_MAX_LAYERS: int = 10  # 最大网格层数
GRID_RISK_PER_LAYER: float = 0.5  # 每层网格风险（账户的0.5%）
```

## 代码结构

### 1. GridStrategyGenerator 类

位置：`strategies/box_strategy_v5_2.py`

主要方法：
- `calculate_grid()`: 计算网格参数
- `check_grid_signal()`: 检查网格交易信号

### 2. BacktestEngine 集成

- 在 `RANGE_BOUND` 状态下调用网格策略
- 使用 `grid_positions` 字典管理网格持仓（key=layer, value=position）
- 网格持仓使用 `trade_type='grid'` 标识

### 3. LiveTradingBotV52 集成

- 在 `check_signals()` 中处理网格信号
- 网格开仓使用限价单（更精确），失败则用市价单
- 网格持仓的止盈/止损检查在持仓管理中处理

## 示例场景

### 场景1：牛市震荡区间做多网格

```
箱体：10000 - 11000 USDT（10%区间）
当前价格：10500 USDT
大趋势：BULLISH
网格间隔：1.5%（约150 USDT）

网格层：
- 层1：10000（买入）→ 止盈10150，止损9950
- 层2：10150（买入）→ 止盈10300，止损10000
- 层3：10300（买入）→ 止盈10450，止损10150
- ...
- 层7：11000（买入）→ 止盈11000（箱体上沿），止损10850
```

### 场景2：熊市震荡区间做空网格

```
箱体：10000 - 11000 USDT（10%区间）
当前价格：10500 USDT
大趋势：BEARISH
网格间隔：1.5%（约150 USDT）

网格层：
- 层1：11000（卖出）→ 止盈10850，止损11150
- 层2：10850（卖出）→ 止盈10700，止损11000
- 层3：10700（卖出）→ 止盈10550，止损10850
- ...
- 层7：10000（卖出）→ 止盈10000（箱体下沿），止损10150
```

## 风险控制

1. **仓位限制**：每层风险0.5%，总风险不超过42%
2. **止损保护**：每层都有止损（网格间隔的一半）
3. **箱体约束**：只在箱体内交易，突破后不交易
4. **方向过滤**：牛市只做多，熊市只做空，避免逆势

## 注意事项

1. **网格间隔要求**：至少1%，确保有足够的利润空间
2. **箱体区间要求**：至少5%，确保网格有足够的操作空间
3. **最后一层止盈**：必须在箱体内（箱体上沿/下沿）
4. **价格容差**：网格触发容差为1%，避免过于敏感
5. **限价单vs市价单**：优先使用限价单，失败则用市价单

## 与v5.2的区别

- **v5.2**：震荡区间不交易（`pass`）
- **v5.3**：震荡区间使用网格策略，提高资金利用率

## 回测与实盘

- **回测**：在 `BacktestEngine.run()` 中处理网格信号
- **实盘**：在 `LiveTradingBotV52.check_signals()` 中处理网格信号
- **通知**：网格开仓/平仓会发送PushPlus通知（如果配置）

## 未来优化方向

1. **动态网格间隔**：根据波动率（ATR）动态调整
2. **网格层数优化**：根据箱体大小和资金量动态调整
3. **部分止盈**：网格层可以部分止盈，保留部分仓位
4. **网格重启**：箱体重新计算后，自动调整网格层
