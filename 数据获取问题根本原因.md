# 数据获取问题根本原因分析

## 问题确认

你说得对！原代码设置 `limit=500`，理论上应该获取5.2天数据，但云端实际只获取了1天（96条）。

## 根本原因

### 问题：未指定时间范围

**原代码**：
```python
ohlcv_15m = self.exchange.fetch_ohlcv(
    self.config.symbol,
    '15m',
    limit=500  # 只指定了limit，没有指定since
)
```

**问题**：
- 币安/OKX的 `fetch_ohlcv` 如果不指定 `since` 参数，**可能只返回最近的数据**
- 某些交易所默认只返回最近24小时的数据
- 或者有默认的时间限制

**结果**：
- 请求500条，实际只返回96条（1天）
- 数据不足 → 指标计算不准确 → 市场状态 `uncertain` → 没有信号

## 解决方案

### 修复：明确指定时间范围

**修复后的代码**：
```python
# 计算起始时间：从当前时间往前推 limit * 15分钟
end_ts = int(datetime.now().timestamp() * 1000)
start_ts = end_ts - (limit * 15 * 60 * 1000)

# 使用since参数明确指定起始时间
ohlcv_15m = self.exchange.fetch_ohlcv(
    self.config.symbol,
    '15m',
    since=start_ts,  # 【关键】明确指定起始时间
    limit=limit
)
```

### 关键改进

1. **明确指定 `since` 参数**：确保获取指定时间范围的数据
2. **自动计算时间范围**：根据需要的K线数量计算起始时间
3. **数据量验证**：检查实际获取的数据量，如果不足会警告

## 验证

修复后，日志应该显示：
```
自动计算历史数据量: 7680条（约80天），用于计算箱体等指标
获取了 7680 条15m数据（请求7680条，时间范围：2025-10-03 到 2025-12-22）
```

而不是：
```
获取了 96 条15m数据  # ❌ 数据不足
```

## 总结

**问题根源**：原代码只指定了 `limit=500`，没有指定 `since` 参数，导致交易所只返回了最近的数据（96条）。

**修复方案**：明确指定 `since` 参数，计算需要的时间范围，确保获取足够的历史数据。
