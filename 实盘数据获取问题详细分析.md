# 实盘数据获取问题详细分析

## 问题现象

**原代码设置**：
```python
df_15m, df_1h, df_4h = self.fetch_historical_data(limit=500)
```

**理论应该获取**：
- 500条15分钟K线 = 5.2天数据

**实际云端获取**：
- 只有96条15分钟K线 = 1天数据

## 可能的原因

### 1. 交易所API限制 ⚠️

币安/OKX的 `fetch_ohlcv` 可能有以下限制：
- **默认限制**：某些交易所默认只返回最近的数据
- **时间限制**：可能只返回最近24小时的数据
- **需要指定since参数**：要获取更早的数据，需要明确指定起始时间

### 2. 代码逻辑问题

原代码可能的问题：
```python
ohlcv_15m = self.exchange.fetch_ohlcv(
    self.config.symbol,
    timeframe_15m,
    limit=500  # 请求500条
)
```

如果交易所不支持直接获取500条，或者有默认限制，可能只返回了96条。

### 3. 数据获取失败但未报错

可能获取过程中出错，但代码继续执行，只获取到了部分数据。

## 解决方案

### 修复后的代码逻辑

1. **明确指定时间范围**：
   ```python
   # 计算需要的时间范围
   end_ts = int(datetime.now().timestamp() * 1000)
   start_ts = end_ts - (80 * 24 * 60 * 60 * 1000)  # 80天前
   
   # 使用since参数明确指定起始时间
   ohlcv = exchange.fetch_ohlcv(symbol, '15m', since=start_ts, limit=1000)
   ```

2. **分批获取**：
   - 如果limit超过交易所限制，自动分批获取
   - 从最新开始，逐步往前获取

3. **数据量验证**：
   - 检查实际获取的数据量
   - 如果不足，输出警告并尝试继续获取

## 验证方法

修复后，检查日志应该看到：
```
自动计算历史数据量: 7680条（约80天），用于计算箱体等指标
获取了 7680 条15m数据
```

而不是：
```
获取了 96 条15m数据  # ❌ 数据不足
```

## 关键修复点

1. **使用since参数明确时间范围**：确保获取足够的历史数据
2. **自动计算所需数据量**：至少80天（7,680条）
3. **分批获取支持**：如果单次请求限制，自动分批
4. **数据量验证**：检查是否获取到足够的数据
