# 实盘数据更新机制说明

## 回答：是的，实盘代码会自动获取全部历史数据并重新计算指标

### 当前实现逻辑

#### 1. 主循环机制

```python
def run(self):
    while self.running:
        # 每60秒检查一次信号
        if current_time - last_check_time >= self.config.check_interval:  # check_interval = 60秒
            signal = self.check_signals()  # 每次检查都调用
```

#### 2. 信号检查流程（每次都会执行）

```python
def check_signals(self):
    # 步骤1：获取最新历史数据（每次都会重新获取）
    df_15m, df_1h, df_4h = self.fetch_historical_data(limit=None)
    # limit=None 会自动计算为至少80天（7,680条15分钟K线）
    
    # 步骤2：重新计算所有指标（每次都会重新计算）
    self.strategy_engine._precalc(df_15m.copy(), df_1h.copy(), df_4h.copy())
    # 这会重新计算：
    # - ATR、ATR百分位
    # - 箱体（box_h, box_l）
    # - EMA（EMA20, EMA50, EMA100）
    # - 反转K线（bull, bear）
    # - 价格位置（price_pos）
    
    # 步骤3：根据最新数据判断市场状态
    regime = self.strategy_engine._get_market_regime(htf_idx, current_idx)
    big_trend = self.strategy_engine._get_big_trend(htf_idx)
    
    # 步骤4：检查交易信号（网格/趋势）
    # ...
```

### 关键特性

✅ **每次检查都获取最新数据**：
- 调用 `fetch_historical_data(limit=None)` 时，会从交易所获取最新的历史数据
- 自动计算至少80天的数据量（7,680条15分钟K线）
- 使用 `since` 参数明确指定时间范围，确保获取足够的历史数据

✅ **每次检查都重新计算指标**：
- 调用 `_precalc()` 重新计算所有技术指标
- 箱体、EMA、ATR等都会根据最新数据重新计算
- 确保指标始终基于最新的历史数据

✅ **每次检查都重新判断交易条件**：
- 市场状态（range_bound/trending_up/trending_down）
- 大趋势（bullish/bearish/neutral）
- 箱体范围、价格位置
- 网格信号、趋势信号

### 检查频率

- **默认间隔**：每60秒检查一次（`check_interval = 60`）
- **主循环休眠**：每次循环后休眠5秒

### 数据获取详情

每次调用 `fetch_historical_data(limit=None)` 时：

1. **自动计算所需数据量**：
   ```python
   min_days = 80  # 至少80天
   limit = min_days * 96  # 7,680条15分钟K线
   ```

2. **明确指定时间范围**：
   ```python
   end_ts = int(datetime.now().timestamp() * 1000)
   start_ts = end_ts - (limit * 15 * 60 * 1000)
   
   ohlcv = exchange.fetch_ohlcv(
       symbol, '15m',
       since=start_ts,  # 明确指定起始时间
       limit=limit
   )
   ```

3. **支持分批获取**：
   - 如果数据量超过1000条（交易所限制），自动分批获取
   - 确保获取到足够的历史数据

### 总结

**是的，实盘代码完全支持：**

1. ✅ **自动获取全部历史数据**：每次检查时都获取至少80天的历史数据
2. ✅ **自动重新计算指标**：每次检查时都重新计算所有技术指标
3. ✅ **自动判断交易条件**：每次检查时都根据最新数据判断所有交易规则的前置条件

**工作流程**：
```
每60秒循环一次
  ↓
获取最新历史数据（80天）
  ↓
重新计算所有指标（箱体、EMA、ATR等）
  ↓
判断市场状态、大趋势
  ↓
检查交易信号（网格/趋势）
  ↓
如果有信号 → 执行交易
  ↓
休眠5秒，继续循环
```

这样确保了：
- 指标始终基于最新的历史数据
- 交易决策始终基于最新的市场状态
- 不会因为数据过期而错过交易机会
