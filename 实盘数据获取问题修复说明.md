# 实盘数据获取问题修复说明

## 问题发现

你的理解是**完全正确的**！实盘交易时确实应该能获取币安的历史K线数据，根据实时数据来计算。

但是，**实盘代码存在一个严重问题**：

### 问题：历史数据量不足

**实盘代码中的问题**：
```python
# 原代码（第585行）
df_15m, df_1h, df_4h = self.fetch_historical_data(limit=500)
```

**问题分析**：
- `limit=500` 表示只获取500条15分钟K线
- 500条 × 15分钟 = 7,500分钟 = 125小时 = **约5.2天**
- 但策略需要至少 **70天** 数据来计算箱体（`BOX_LOOKBACK_PERIODS = 70`）
- 数据不足 → 指标计算不准确 → 市场状态判断为 `uncertain` → 没有信号

### 对比

| 项目 | 原代码 | 需要的数据 |
|------|--------|-----------|
| 获取的K线数 | 500条 | 至少6,720条（70天） |
| 时间跨度 | 约5.2天 | 至少70天 |
| 箱体计算 | ❌ 不准确 | ✅ 准确 |
| 市场状态 | ❌ uncertain | ✅ range_bound |

## 修复方案

已修复 `live_trading_v52.py`，主要改动：

### 1. 自动计算所需数据量

```python
def fetch_historical_data(self, limit: int = None):
    # 自动计算：至少80天数据
    if limit is None:
        min_days = 80
        limit = min_days * 96  # 15分钟K线：每天96条
```

### 2. 支持大批量数据获取

如果数据量超过1000条（交易所单次请求限制），自动分批获取。

### 3. 数据量检查

```python
min_required = 70 * 96  # 70天 * 96条/天
if len(df_15m) < min_required:
    logger.warning("数据不足，可能导致指标计算不准确")
```

### 4. 修复所有调用点

- `check_signals()`: 使用 `limit=None`（自动计算）
- 检查出场时: 也使用 `limit=None`（确保数据充足）

## 修复后的效果

修复后，实盘代码会：
1. ✅ 自动获取至少80天的历史数据（约7,680条15分钟K线）
2. ✅ 确保箱体计算准确
3. ✅ 确保市场状态判断准确
4. ✅ 能够正常生成交易信号

## 验证方法

修复后，可以在云端运行：

```bash
# 检查信号（使用修复后的代码）
docker exec -it my_trading_system_bot_2 python3 check_recent_signals_fixed.py --days 70 --check-days 3
```

或者直接查看实盘日志，应该能看到：
- 数据获取日志：显示获取了多少条数据
- 市场状态：应该是 `range_bound` 而不是 `uncertain`
- 交易信号：应该能正常生成

## 总结

**你的理解是对的**：实盘交易时应该能获取历史K线数据。

**问题在于**：原代码只获取了5.2天的数据，而策略需要70天，导致指标计算不准确。

**已修复**：现在会自动获取至少80天的历史数据，确保指标计算准确。
